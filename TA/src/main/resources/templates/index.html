<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<title>ìš°ë¦¬ ë™ë„¤ ì§€ë°˜ì¹¨í•˜ ì•ˆì „ì ìˆ˜</title>
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=cd3f88c99b509eab24270116d671ff65&libraries=services,clusterer"></script>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background-color: white;
		}

		#wrap {
			max-width: 1200px;
			margin: auto;
			height: 100%;
			display: flex;
			flex-direction: column;
		}

		#header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 15px 20px;
			position: relative;
			justify-content: space-between;
			padding: 15px 20px;
		}

		.menu-icon {
			width: 25px;
			height: 20px;
			background-image:
				url('data:image/svg+xml;charset=UTF-8,<svg width="25" height="20" xmlns="http://www.w3.org/2000/svg"><rect width="25" height="3" y="0" fill="%23333"/><rect width="25" height="3" y="8" fill="%23333"/><rect width="25" height="3" y="16" fill="%23333"/></svg>');
			background-size: cover;
		}

		#container {
			flex: 1;
			position: relative;
		}

		#map {
			width: 100%;
			height: 100%;
		}

		.search-bar {
			position: absolute;
			top: 20px;
			left: 50%;
			transform: translateX(-50%);
			align-items: center;
			background: white;
			padding: 0px 15px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
			border: 2px solid #337DFF;
			border-radius: 18px;
			z-index: 10;
			height: 44px;
			display: flex;
			justify-content: center;
			width: 750px;
		}

		.search-bar input {
			width: 100%;
			padding: 10px 12px;
			border: none;
			font-size: 14px;
			outline: none;
		}

		.btn_search {
			background: none;
			border: none;
			margin-left: 10px;
			cursor: pointer;
		}

		.btn_search:hover {
			opacity: 0.8;
		}

		.btn_search img {
			width: 25px;
			height: 25px;
		}

		#result-list {
			position: absolute;
			top: 66px;
			left: 50%;
			transform: translateX(-50%);
			width: 100%;
			max-width: 750px;
			overflow-y: auto;
			background: white;
			border: 2px solid #337DFF;
			border-radius: 0px 0px 18px 18px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
			z-index: 15;
			padding: 0px 15px;
			display: none;
		}

		#result-list div {
			padding: 10px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
		}

		#result-list div:hover {
			background-color: #f0f0f0;
		}

		.menu-icon {
			width: 25px;
			height: 20px;
			background-image:
				url('data:image/svg+xml;charset=UTF-8,<svg width="25" height="20" xmlns="http://www.w3.org/2000/svg"><rect width="25" height="3" y="0" fill="%23333"/><rect width="25" height="3" y="8" fill="%23333"/><rect width="25" height="3" y="16" fill="%23333"/></svg>');
			background-size: cover;
			cursor: pointer;
		}

		#menuList {
			position: absolute;
			top: 60px;
			left: 20px;
			background-color: #f9f9f9;
			border: 1px solid #ccc;
			border-radius: 10px;
			padding: 15px;
			width: 200px;
			display: none;
			z-index: 999;
		}

		.login-message {
			font-size: 14px;
			color: #333;
			margin-bottom: 10px;
			font-weight: bold;
		}

		.login-btn {
			display: block;
			width: 100%;
			padding: 8px;
			background-color: #337DFF;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			margin-bottom: 10px;
		}

		#menuList ul {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		#menuList ul li {
			padding: 8px;
			cursor: pointer;
			border-bottom: 1px solid #eee;
		}

		#menuList ul li:hover {
			background-color: #eee;
		}

		.radius_border {
			border: 1px solid #919191;
			border-radius: 5px;
		}

		.custom_location_control {
			position: absolute;
			top: 80px;
			left: 10px;
			width: 32px;
			height: 32px;
			overflow: hidden;
			z-index: 1;
			background-color: #f5f5f5;
		}

		.custom_location_control span {
			display: block;
			width: 32px;
			height: 32px;
			text-align: center;
			cursor: pointer;
		}

		.custom_location_control span img {
			width: 15px;
			height: 15px;
			padding: 9px 0;
			border: none;
		}

		.custom_location_control span img:hover {
			opacity: 0.5;
		}

		.radius_border {
			border: 1px solid #919191;
			border-radius: 5px;
		}

		#popupOverlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		#popupContent {
			background: white;
			padding: 30px;
			border-radius: 12px;
			width: 400px;
			max-width: 80%;
			text-align: center;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		}

		#popupContent h2 {
			margin-top: 0;
			color: #337DFF;
		}

		#popupContent button {
			margin-top: 20px;
			padding: 8px 16px;
			background-color: #337DFF;
			color: white;
			border: none;
			border-radius: 6px;
			cursor: pointer;
		}

		#popupContent button:hover {
			background-color: #285fd0;
		}
	</style>
</head>

<body>

	<!-- íŒì—… ì˜¤ë²„ë ˆì´ -->
	<div id="popupOverlay">
		<div id="popupContent">
			<h2>ì”½í¬ì˜¬</h2>
			<p>ìš°ë¦¬ ë™ë„¤ ì§€ë°˜ì¹¨í•˜ ì•ˆì „ì ìˆ˜ ì„œë¹„ìŠ¤</p>
			<p>ì‹±í¬í™€ ìµœì´ˆì‹ ê³  í¬ìƒì œë„ ì‹œí–‰ì¤‘!!</p>
			<button onclick="closePopup()">ë‹«ê¸°</button>
		</div>
	</div>

	<div id="wrap">
		<div id="header">
			<div class="menu-icon" onclick="toggleMenu()"></div>
			<div id="menuList">
				<div class="login-message" th:if="${userName != null}">
					<span th:text="${userName} + 'ë‹˜'"></span>
				</div>
				<div class="login-message" th:if="${userName == null}">ë¡œê·¸ì¸ì´
					í•„ìš”í•©ë‹ˆë‹¤.</div>


				<button class="login-btn" th:if="${userName == null}" onclick="location.href='/login'">ë¡œê·¸ì¸</button>
				<ul>
					<li onclick="location.href='/report'">ì œë³´ê²Œì‹œíŒ</li>
					<li onclick="location.href='/reward'">ì‹ ê³  í¬ìƒê¸ˆ ì œë„</li>
					<li onclick="location.href='/statistics'">ë°ì´í„° í†µê³„</li>
					<li onclick="location.href='/response'">ëŒ€ì²˜ë°©ë²•</li>
					<li onclick="location.href='/service'">ì„œë¹„ìŠ¤ ì„¤ëª…</li>
					<li onclick="location.href='/notice'">ê³µì§€ì‚¬í•­</li>

				</ul>
				<button class="login-btn" th:if="${userName != null}" onclick="location.href='/logout'">ë¡œê·¸ì•„ì›ƒ</button>


			</div>
		</div>

		<div id="container">
			<div id="map">
				<div class="search-bar">
					<input type="text" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
					<button type="submit" class="btn_search">
						<img src="img/search_btn.png" alt="ê²€ìƒ‰ ë²„íŠ¼">
					</button>
				</div>
				<div id="result-list"></div>
			</div>
			<div class="custom_location_control radius_border">
				<span onclick="user_location()"> <img src="img/target.png">
				</span>
			</div>

		</div>
	</div>

	<script>
		// ë©”ë‰´ ë²„íŠ¼
		function toggleMenu() {
			const menu = document.getElementById("menuList");
			menu.style.display = (menu.style.display === "block") ? "none" : "block";
		}

		let user_lat = 37.5665
		let user_lng = 126.9780



		const container = document.getElementById('map');
		const mapOptions = {
			center: new kakao.maps.LatLng(user_lat, user_lng),
			level: 4
		};
		const map = new kakao.maps.Map(container, mapOptions);
		// ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ ìˆ˜ì§‘
		user_location();


		const input = document.querySelector('.search-bar input');
		const searchBtn = document.querySelector('.btn_search');
		const resultList = document.getElementById('result-list');
		const geocoder = new kakao.maps.services.Geocoder();
		const ps = new kakao.maps.services.Places();
		const search_bar = document.querySelector('.search-bar')

		let markers = [];

		// ì§€ë„ í™•ëŒ€ ì¶•ì†Œë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ”  ì¤Œ ì»¨íŠ¸ë¡¤ì„ ìƒì„±í•©ë‹ˆë‹¤
		var zoomControl = new kakao.maps.ZoomControl();
		map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

		// ë§ˆì»¤ ì§€ìš°ê¸°
		function clearMarkers() {
			markers.forEach(marker => marker.setMap(null));
			markers = [];
		}

		function displayResults(data) {
			resultList.innerHTML = '';
			clearMarkers();

			if (!data.length) {
				resultList.style.display = 'none';
				return;
			}

			data.forEach(place => {
				const item = document.createElement('div');
				item.textContent = place.place_name;
				item.addEventListener('click', () => {
					const coords = new kakao.maps.LatLng(place.y, place.x);
					map.setCenter(coords);

					clearMarkers();
					const marker = new kakao.maps.Marker({
						map: map,
						position: coords
					});
					markers.push(marker);

					resultList.style.display = 'none';
					search_bar.style.borderRadius = "18px"
					input.value = item.textContent
				});
				resultList.appendChild(item);
			});

			resultList.style.display = 'block';
		}

		function searchPlaces() {
			search_bar.style.borderRadius = "18px 18px 0px 0px"

			const keyword = input.value.trim();
			if (!keyword) {
				resultList.style.display = 'none';
				search_bar.style.borderRadius = "18px";
				return;
			}
			ps.keywordSearch(keyword, (data, status) => {
				if (status === kakao.maps.services.Status.OK && data.length > 0) {
					displayResults(data);
				} else {
					resultList.innerHTML = '<div style="padding: 10px; color: gray; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
					resultList.style.display = 'block';
					search_bar.style.borderRadius = "18px 18px 0px 0px";
					clearMarkers();
				}
			});
		}


		// ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ê²€ìƒ‰
		searchBtn.addEventListener('click', () => {
			searchPlaces();
		});

		// ì…ë ¥ ì¤‘ ìë™ì™„ì„± ê²€ìƒ‰
		input.addEventListener('keyup', (e) => {
			searchPlaces();

			if (e.key === 'Enter') {
				resultList.style.display = 'none';
			}
		});

		function user_location() {
			let userLocation = navigator.geolocation.getCurrentPosition((position) => {
				map.setCenter(new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude))
			})
		}

		// íŒì—… ë‹«ê¸°
		function closePopup() {
			const popup = document.getElementById('popupOverlay');
			popup.style.display = 'none';
		}

		// ì˜¤ë²„ë ˆì´ ì „ì—­ ì„ ì–¸
		let currentOverlay = null;

		function fetchMarkersInBounds() {
			const bounds = map.getBounds();
			const sw = bounds.getSouthWest();
			const ne = bounds.getNorthEast();

			const url = `/api/occur/within?swLat=${sw.getLat()}&swLng=${sw.getLng()}&neLat=${ne.getLat()}&neLng=${ne.getLng()}`;

			fetch(url)
				.then(res => res.json())
				.then(data => {
					// ê¸°ì¡´ ë§ˆì»¤ ì œê±°
					markers.forEach(m => m.setMap(null));
					markers = [];

					// ìƒˆë¡œìš´ ë§ˆì»¤ ìƒì„±
					data.forEach(d => {
						const marker = new kakao.maps.Marker({
							map: map,
							position: new kakao.maps.LatLng(d.latitude, d.longitude),
							title: d.location
						});

						kakao.maps.event.addListener(marker, 'click', function () {
							if (currentOverlay) currentOverlay.setMap(null);

							const content = `
			              <div style="width: 300px; border-radius:10px; box-shadow:0px 2px 6px rgba(0,0,0,0.3); background:white; font-family:sans-serif;">
			                <div style="background:#1e90ff; color:white; padding:10px; border-radius:10px 10px 0 0; font-weight:bold; display:flex; justify-content:space-between;">
			                  <span>ì‹±í¬í™€ ì§€ë„ ìƒì„¸ ì •ë³´</span>
			                  <span onclick="overlayClose()" style="cursor:pointer;">âŒ</span>
			                </div>
			                <div style="padding:10px; font-size:14px;">
			                  <p><strong>ğŸ“ ë°œìƒ ìœ„ì¹˜:</strong> ${d.location}</p>
			                  <p><strong>ğŸ“… ë°œìƒ ì¼ì:</strong> ${d.sagoDate}</p>
			                  <p><strong>ğŸ“ ì‹±í¬í™€ ê·œëª¨:</strong> ${d.sinkWidth}m / ${d.sinkExtend}m / ${d.sinkDepth}m</p>
			                  <p><strong>ğŸª¨ ì§€ì§ˆ:</strong> ${d.bedType} <br><span style="color:gray; font-size:12px;">${d.bedInfo}</span></p>
			                  <p><strong style="color:red;">âš ï¸ ë°œìƒ ì›ì¸:</strong> ${d.sagoDetail}</p>
			                  ${d.sagoImgUrl !== 'nan' ? `<img src="${d.sagoImgUrl}" style="width:100%; margin:10px 0; border-radius:8px;">` : ''}
			                  <p><strong>ğŸš— ì°¨ëŸ‰ í”¼í•´:</strong> ${d.vehicleCnt}ëŒ€</p>
			                  ${d.sagoNewsUrl !== 'nan' ? `<p><strong>ğŸ“° ë‰´ìŠ¤ ë§í¬:</strong> <a href="${d.sagoNewsUrl}" target="_blank">${d.sagoNewsUrl}</a></p>` : ''}
			                  <p><strong>ğŸ”§ ì²˜ë¦¬ ìƒíƒœ:</strong> ${d.trStatus} (${d.trFnDate})</p>
			                  <p><strong>ğŸ›  ì²˜ë¦¬ ë°©ë²•:</strong> ${d.trMethod}</p>
			                  <button onclick="overlayClose()" style="width:100%; margin-top:10px; padding:8px; background:#1e90ff; border:none; color:white; border-radius:6px;">ë‹«ê¸°</button>
			                </div>
			              </div>
			            `;

							currentOverlay = new kakao.maps.CustomOverlay({
								content: content,
								position: marker.getPosition(),
								xAnchor: 0.5,
								yAnchor: 1.0
							});

							currentOverlay.setMap(map);
						});
						markers.push(marker);
					});
				});
		}

		// ì§€ë„ ì´ë™ ë˜ëŠ” í™•ëŒ€/ì¶•ì†Œ ì‹œë§ˆë‹¤ ë§ˆì»¤ ê°±ì‹ 
		kakao.maps.event.addListener(map, 'idle', fetchMarkersInBounds);

		// ìµœì´ˆ ë¡œë”© ì‹œ ì‹¤í–‰
		fetchMarkersInBounds();

		// ì˜¤ë²„ë ˆì´ ë‹«ê¸° í•¨ìˆ˜
		function overlayClose() {
			if (currentOverlay) currentOverlay.setMap(null);
		}



	</script>
</body>

</html>